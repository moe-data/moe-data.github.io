name: dump

on:
  push:
    paths:
      - '**.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘  push:

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      month: ${{ steps.set-month.outputs.month }}
      c_changed: ${{ steps.pre-check.outputs.c_changed }}
      d_changed: ${{ steps.pre-check.outputs.d_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set current month
        id: set-month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹1ï¼šå®‰è£…Git LFSï¼ˆç”¨äºæ¨é€gzæ–‡ä»¶ï¼‰
      - name: Install Git LFS
        run: |
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          # è·Ÿè¸ª drop*.gz æ–‡ä»¶
          git lfs track "dump/drop*.gz"


      # æ ¸å¿ƒæ”¹2ï¼šå…ˆä»…è·å–ETagï¼ˆä¸ä¸‹è½½æ–‡ä»¶ï¼‰ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
      - name: Get ETag only (no file download)
        id: get-etag
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          echo "======= ã€å‰ç½®ã€‘ä»…è·å–ETag + è‡ªæ£€ ======="
          
          # åˆå§‹åŒ–ETagå˜é‡+è‡ªæ£€æ ‡è®°
          echo "--- å¤„ç† createitemrecords ---"
          CREATES_ETAG=""
          CREATES_ETAG_STATUS="failed"
          # curl åŠ  -w %{http_code} æ£€æŸ¥å“åº”çŠ¶æ€ï¼Œé¿å…æ—  ETag æ—¶è¯»å–å¤±è´¥
          RESPONSE=$(curl -s -I -w "%{http_code}" https://api.poi.moe/dump/createitemrecords.gz)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" -eq 200 ]; then
            CREATES_ETAG=$(echo "$RESPONSE" | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}' | tr -d '"')
            CREATES_ETAG_STATUS="success"
          fi
          echo "creates ETag è¯»å–çŠ¶æ€: $CREATES_ETAG_STATUS"
          echo "creates æœ€æ–° ETag: $CREATES_ETAG"
          echo "CREATES_ETAG=$CREATES_ETAG" >> $GITHUB_OUTPUT
          echo "CREATES_ETAG_STATUS=$CREATES_ETAG_STATUS" >> $GITHUB_OUTPUT
          
          # è·å– drops çš„ ETagï¼ˆåŒæ ·å¢åŠ é”™è¯¯å¤„ç†ï¼‰
          echo "--- å¤„ç† createshiprecords ---"
          DROPS_ETAG=""
          DROPS_ETAG_STATUS="failed"
          RESPONSE=$(curl -s -I -w "%{http_code}" https://api.poi.moe/dump/createshiprecords.gz)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" -eq 200 ]; then
            DROPS_ETAG=$(echo "$RESPONSE" | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}' | tr -d '"')
            DROPS_ETAG_STATUS="success"
          fi
          echo "drops ETag è¯»å–çŠ¶æ€: $DROPS_ETAG_STATUS"
          echo "drops æœ€æ–° ETag: $DROPS_ETAG"
          echo "DROPS_ETAG=$DROPS_ETAG" >> $GITHUB_OUTPUT
          echo "DROPS_ETAG_STATUS=$DROPS_ETAG_STATUS" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹3ï¼šå…ˆè¯»å–å†å²ETagï¼Œå¯¹æ¯”åå†³å®šæ˜¯å¦ä¸‹è½½/å–æ¶ˆå·¥ä½œæµ
      - name: Check ETag change before download
        id: pre-check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          mkdir -p dump # ç¡®ä¿dumpç›®å½•å­˜åœ¨

          # åˆå§‹åŒ–å˜æ›´æ ‡è®°
          C_CHANGED="true"
          D_CHANGED="true"
          # åˆå§‹åŒ–å†å²ETagå˜é‡
          HIST_CREATES_ETAG=""
          HIST_DROPS_ETAG=""

          echo "======= è¯»å–å†å² monthly_size.txtï¼ˆc/d åˆ†å¼€ï¼‰======="
          # è¯»å–monthly_size.txtä¸­çš„å†å²ETagï¼ˆé”®å€¼æ ¼å¼ï¼‰
          if [ -f "$MONTHLY_SIZE_FILE" ]; then
            # æå– c{å¹´æœˆ}_ETAG çš„å€¼
            HIST_CREATES_ETAG=$(grep -E "^c${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            # æå– d{å¹´æœˆ}_ETAG çš„å€¼
            HIST_DROPS_ETAG=$(grep -E "^d${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            echo "å†å² c${MONTH} ETag: $HIST_CREATES_ETAG"
            echo "å†å² d${MONTH} ETag: $HIST_DROPS_ETAG"
          else
            echo "======= monthly_size.txtä¸å­˜åœ¨ï¼Œé¦–æ¬¡æ‰§è¡Œ ======="
            echo "c_changed=$C_CHANGED" >> $GITHUB_OUTPUT
            echo "d_changed=$D_CHANGED" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ===== åˆ†å¼€åˆ¤æ–­ c çš„ ETagï¼ˆä»…è¯»å–æˆåŠŸæ—¶æ‰å¯¹æ¯”ï¼‰=====
          echo "--- å¯¹æ¯” creates ETag ---"
          if [ "${{ steps.get-etag.outputs.CREATES_ETAG_STATUS }}" = "success" ] && [ -n "$HIST_CREATES_ETAG" ] && [ -n "${{ steps.get-etag.outputs.CREATES_ETAG }}" ]; then
            if [ "${{ steps.get-etag.outputs.CREATES_ETAG }}" = "$HIST_CREATES_ETAG" ]; then
              C_CHANGED="false"
              echo "creates ETag å®Œå…¨ä¸€è‡´ï¼Œæ— æ›´æ–°"
            else
              C_CHANGED="true"
              echo "creates ETag ä¸ä¸€è‡´ï¼ˆå†å²ï¼š$HIST_CREATES_ETAG | æœ€æ–°ï¼š${{ steps.get-etag.outputs.CREATES_ETAG }}ï¼‰"
            fi
          else
            C_CHANGED="true"
            echo "creates ETag è¯»å–å¤±è´¥/å†å²ä¸å­˜åœ¨ï¼Œåˆ¤å®šä¸ºæœ‰æ›´æ–°"
          fi

          # ===== åˆ†å¼€åˆ¤æ–­ d çš„ ETagï¼ˆä»…è¯»å–æˆåŠŸæ—¶æ‰å¯¹æ¯”ï¼‰=====
          echo "--- å¯¹æ¯” drops ETag ---"
          if [ "${{ steps.get-etag.outputs.DROPS_ETAG_STATUS }}" = "success" ] && [ -n "$HIST_DROPS_ETAG" ] && [ -n "${{ steps.get-etag.outputs.DROPS_ETAG }}" ]; then
            if [ "${{ steps.get-etag.outputs.DROPS_ETAG }}" = "$HIST_DROPS_ETAG" ]; then
              D_CHANGED="false"
              echo "drops ETag å®Œå…¨ä¸€è‡´ï¼Œæ— æ›´æ–°"
            else
              D_CHANGED="true"
              echo "drops ETag ä¸ä¸€è‡´ï¼ˆå†å²ï¼š$HIST_DROPS_ETAG | æœ€æ–°ï¼š${{ steps.get-etag.outputs.DROPS_ETAG }}ï¼‰"
            fi
          else
            D_CHANGED="true"
            echo "drops ETag è¯»å–å¤±è´¥/å†å²ä¸å­˜åœ¨ï¼Œåˆ¤å®šä¸ºæœ‰æ›´æ–°"
          fi

          # è¾“å‡ºå˜æ›´æ ‡è®°åˆ°GitHubå˜é‡
          echo "c_changed=$C_CHANGED" >> $GITHUB_OUTPUT
          echo "d_changed=$D_CHANGED" >> $GITHUB_OUTPUT
          # è¾“å‡ºæ•´ä½“å˜æ›´æ ‡è®°ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          if [ "$C_CHANGED" = "false" ] && [ "$D_CHANGED" = "false" ]; then
            echo "æ•´ä½“æ— å˜æ›´ï¼ˆc/d ETag å‡ä¸€è‡´ï¼‰"
          else
            echo "æ•´ä½“æœ‰å˜æ›´ï¼ˆc/d è‡³å°‘ä¸€ä¸ªæœ‰å˜åŒ–ï¼‰"
          fi

      # ä¿®å¤3ï¼šç¬¬ä¸€æ¬¡å–æ¶ˆå·¥ä½œæµï¼ˆä»… c/d ETag å‡æ— å˜åŒ–æ—¶æ‰§è¡Œï¼‰
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆETagæ— å˜åŒ–ï¼‰
        if: steps.pre-check.outputs.c_changed == 'false' && steps.pre-check.outputs.d_changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½æ–‡ä»¶ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      # æ ¸å¿ƒæ”¹5ï¼šä»…ETagå˜åŒ–æ—¶æ‰ä¸‹è½½æ–‡ä»¶
      - name: Download .gz files (only if ETag changed)
        if: steps.pre-check.outputs.c_changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½ createitemrecords.gz ======="
          curl -s -o creates.gz https://api.poi.moe/dump/createitemrecords.gz
          if [ -f "creates.gz" ]; then
            echo "âœ… creates.gz æœ€æ–°MD5: '$MD5_CREATES_GZ'"
          else
            echo "âŒ creates.gzä¸å­˜åœ¨ï¼ŒMD5æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: Download d*.gz (only if d ETag changed)
        if: steps.pre-check.outputs.d_changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½ createshiprecords.gz ======="
          curl -s -o drops.gz https://api.poi.moe/dump/createshiprecords.gz
          if [ -f "drops.gz" ]; then
            echo "âœ… drops.gz æœ€æ–°MD5: '$MD5_DROPS_GZ'"
          else
            echo "âŒ drops.gzä¸å­˜åœ¨ï¼ŒMD5æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: Check if changed
        id: check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          # å¤ç”¨ pre-check çš„ç»“æœï¼Œåˆå§‹åŒ–æ•´ä½“å˜æ›´æ ‡è®°
          C_CHANGED="${{ steps.pre-check.outputs.c_changed }}"
          D_CHANGED="${{ steps.pre-check.outputs.d_changed }}"
          echo "changed=$([ "$C_CHANGED" = "true" ] || [ "$D_CHANGED" = "true" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          
          if [ "$C_CHANGED" = "false" ] && [ "$D_CHANGED" = "false" ]; then
            exit 0 # æ— å˜åŒ–æ—¶ç›´æ¥é€€å‡ºï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
          fi

          # å®šä¹‰æœˆä»½å˜é‡ï¼ˆé¿å…åµŒå¥—å¼•ç”¨é—®é¢˜ï¼‰
          MONTH="${{ steps.set-month.outputs.month }}"
          C_HISTORY_GZ_FILE="dump/c${MONTH}.gz"
          D_HISTORY_GZ_FILE="dump/d${MONTH}.gz"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          
          echo "======= æ‰“å°ETagå†…å®¹ ======="
          # æ‹¼æ¥æœ€æ–°ETagï¼ˆä¿ç•™åŸæœ‰å˜é‡åï¼Œæœ€å°åŒ–æ”¹åŠ¨ï¼‰
          CREATES_ETAG="ETag: ${{ steps.get-etag.outputs.CREATES_ETAG }}"
          DROPS_ETAG="ETag: ${{ steps.get-etag.outputs.DROPS_ETAG }}"
          echo "creates ETag (æ¸…ç†å): $CREATES_ETAG"
          echo "drops ETag (æ¸…ç†å): $DROPS_ETAG"
          
          echo "======= æ‰“å°æ–‡ä»¶MD5å€¼ ======="
          # ===== åˆ†å¼€å¤„ç† c*.gzï¼ˆMD5 æ£€æŸ¥ï¼Œç¬¬äºŒæ¬¡å–æ¶ˆçš„åŸºç¡€ï¼‰=====
          MD5_CREATES_GZ="N/A"
          C_FILE_SIZE_KB="N/A"
          if [ "$C_CHANGED" = "true" ] && [ -f "creates.gz" ]; then
            MD5_CREATES_GZ=$(md5sum creates.gz | awk '{print $1}')
            echo "âœ… creates.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_CREATES_GZ"
            # ç§»åŠ¨æ–‡ä»¶ + è®¡ç®—å¤§å°
            mv creates.gz "$C_HISTORY_GZ_FILE"
            # è®¡ç®— creates æ–‡ä»¶å¤§å°
            C_FILE_SIZE_KB=$(du -k "$C_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $C_HISTORY_GZ_FILE å¤§å°: ${C_FILE_SIZE_KB} KB"
          elif [ "$C_CHANGED" = "false" ]; then
            echo "âœ… creates.gz æ— å˜åŒ–ï¼Œè·³è¿‡ MD5 è®¡ç®—"
          else
            echo "âŒ creates.gz æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # ===== åˆ†å¼€å¤„ç† d*.gzï¼ˆMD5 æ£€æŸ¥ï¼Œç¬¬äºŒæ¬¡å–æ¶ˆçš„åŸºç¡€ï¼‰=====
          MD5_DROPS_GZ="N/A"
          D_FILE_SIZE_KB="N/A"
          if [ "$D_CHANGED" = "true" ] && [ -f "drops.gz" ]; then
            MD5_DROPS_GZ=$(md5sum drops.gz | awk '{print $1}')
            echo "âœ… drops.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_DROPS_GZ"
            # ç§»åŠ¨ drops.gz åˆ°ç›®æ ‡è·¯å¾„
            mv drops.gz "$D_HISTORY_GZ_FILE"
            # è®¡ç®— drops æ–‡ä»¶å¤§å°
            D_FILE_SIZE_KB=$(du -k "$D_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $D_HISTORY_GZ_FILE å¤§å°: ${D_FILE_SIZE_KB} KB"
          elif [ "$D_CHANGED" = "false" ]; then
            echo "âœ… drops.gz æ— å˜åŒ–ï¼Œè·³è¿‡ MD5 è®¡ç®—"
          else
            echo "âŒ drops.gz æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # ===== ä¿ç•™ï¼šå†™å…¥ monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰======
          echo "======= å†™å…¥ monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰======="
          # è·å–å½“å‰æ£€æŸ¥æ—¶é—´ï¼ˆISO æ ¼å¼ï¼Œæ–¹ä¾¿è§£æï¼‰
          CHECK_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # å…ˆåˆ é™¤å½“å‰æœˆä»½çš„æ—§è®°å½•ï¼ˆé¿å…é‡å¤ï¼‰
          grep -v -E "^[cd]${MONTH}_" "$MONTHLY_SIZE_FILE" > "$MONTHLY_SIZE_FILE.tmp" 2>/dev/null || true
          # å†™å…¥createsçš„é”®å€¼
          if [ "$C_CHANGED" = "true" ]; then
            echo "c${MONTH}_ETAG=\"${{ steps.get-etag.outputs.CREATES_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "c${MONTH}_MD5=\"${MD5_CREATES_GZ}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "c${MONTH}_SizeKB=\"${C_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "c${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          fi
          # å†™å…¥ drops çš„é”®å€¼ï¼ˆä»…å½“æœ‰å˜åŒ–æ—¶ï¼‰
          if [ "$D_CHANGED" = "true" ]; then
            echo "d${MONTH}_ETAG=\"${{ steps.get-etag.outputs.DROPS_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "d${MONTH}_MD5=\"${MD5_DROPS_GZ}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "d${MONTH}_SizeKB=\"${D_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
            echo "d${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          fi
          # æ›¿æ¢åŸæ–‡ä»¶
          mv "$MONTHLY_SIZE_FILE.tmp" "$MONTHLY_SIZE_FILE"
          
          # æ‰“å°å†™å…¥ç»“æœ
          echo "âœ… monthly_size.txt å†™å…¥å®Œæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
          cat "$MONTHLY_SIZE_FILE"

          # ====================== åŸæœ‰é€»è¾‘ï¼šè¾“å‡ºæœ€ç»ˆç»“è®º ======================
          echo -e "\n======= ã€æ ¸å¿ƒã€‘æœ€ç»ˆåˆ¤å®š ======="
          echo "ğŸ“Œ æœ€ç»ˆç»“è®ºï¼šData updated! Saving new .gz (ETag/MD5å‡å˜åŒ–)"

      # ä¿®å¤5ï¼šç¬¬äºŒæ¬¡å–æ¶ˆå·¥ä½œæµï¼ˆMD5 æ£€æŸ¥ï¼Œc/d å‡æ— å˜åŒ–æ—¶æ‰§è¡Œï¼‰
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆMD5 æ— å˜åŒ–ï¼Œc/d å‡æ— æ›´æ–°ï¼‰
        if: steps.check.outputs.changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'MD5 æ— å˜åŒ–ï¼ˆc/d å‡ä¸€è‡´ï¼‰ï¼Œæ— éœ€æäº¤ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      - name: Commit and push .gz if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git lfs track "drop*.gz"
          git add dump/
          # æäº¤ä¿¡æ¯åŒ…å« c/d å˜æ›´çŠ¶æ€
          COMMIT_MSG="Update "
          if [ "${{ steps.pre-check.outputs.c_changed }}" = "true" ]; then
            COMMIT_MSG+="createitemrecords "
          fi
          if [ "${{ steps.pre-check.outputs.d_changed }}" = "true" ]; then
            COMMIT_MSG+="createshiprecords "
          fi
          COMMIT_MSG+="${{ steps.set-month.outputs.month }}.gz"
          git commit -m "$COMMIT_MSG"
          git push --force-with-lease
