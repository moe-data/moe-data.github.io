name: dump

on:
  push:
    paths:
      - '**/dump.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘  push:

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      month: ${{ steps.set-month.outputs.month }}
      d_changed: ${{ steps.pre-check.outputs.d_changed }}
      c_changed: ${{ steps.pre-check.outputs.c_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set current month
        id: set-month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹1ï¼šå®‰è£…Git LFSï¼ˆç”¨äºæ¨é€gzæ–‡ä»¶ï¼‰
      - name: Install Git LFS
        run: |
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          # è·Ÿè¸ª drop*.gz æ–‡ä»¶
          git lfs track "dump/drop*.gz"

      # æ ¸å¿ƒæ”¹2ï¼šå…ˆä»…è·å–ETagï¼ˆä¸ä¸‹è½½æ–‡ä»¶ï¼‰ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
      - name: Get ETag only (no file download)
        id: get-etag
        # åˆ‡æ¢ä¸ºPowerShell shellæ‰§è¡ŒETagè·å–
        shell: pwsh
        run: |
          $MONTH="${{ steps.set-month.outputs.month }}"
          echo "======= ã€å‰ç½®ã€‘ä»…è·å–ETag + è‡ªæ£€ ======="
          
          # åˆå§‹åŒ–ETagå˜é‡+è‡ªæ£€æ ‡è®°
          echo "--- å¤„ç† createitemrecords ---"
          $developEtag = $null
          # æç®€PowerShellè·å–ETagï¼Œå»é™¤å¼•å·/ç©ºæ ¼
          $developEtag = (Invoke-WebRequest -Uri "https://api.poi.moe/dump/createitemrecords.gz" -Method Head).Headers['ETag'] -replace '["\s]', ''
          echo "develop ETag è¯»å–çŠ¶æ€: success"
          echo "develop æœ€æ–° ETag: $developEtag"
          # è‡ªæ£€ï¼šETagä¸ºç©ºç›´æ¥exit 2
          if ([string]::IsNullOrEmpty($developEtag)) {
            echo "âŒ develop ETag ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          }
          # è¾“å‡ºåˆ°GitHubå˜é‡
          echo "DEVELOP_ETAG=$developEtag" >> $env:GITHUB_OUTPUT
          echo "DEVELOP_ETAG_STATUS=success" >> $env:GITHUB_OUTPUT
          
          # ===== å¤„ç† createshiprecords ETag =====
          echo "--- å¤„ç† createshiprecords ---"
          $constructEtag = (Invoke-WebRequest -Uri "https://api.poi.moe/dump/createshiprecords.gz" -Method Head).Headers['ETag'] -replace '["\s]', ''
          echo "construct ETag è¯»å–çŠ¶æ€: success"
          echo "construct æœ€æ–° ETag: $constructEtag"
          # è‡ªæ£€ï¼šETagä¸ºç©ºç›´æ¥exit 2
          if ([string]::IsNullOrEmpty($constructEtag)) {
            echo "âŒ construct ETag ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          }
          # è¾“å‡ºåˆ°GitHubå˜é‡
          echo "CONSTRU_ETAG=$constructEtag" >> $env:GITHUB_OUTPUT
          echo "CONSTRU_ETAG_STATUS=success" >> $env:GITHUB_OUTPUT

      # æ–°å¢ï¼šRead historical ETag from JSON (replace TXT)
      - name: Read historical d${{ steps.set-month.outputs.month }} ETag from JSON
        id: read-size-d
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: read
          filename: dump/size-d.json
          field: ${{ steps.set-month.outputs.month }}.ETAG

      # ===== NEW: Read historical ETag from size-c.json (no jq, preserve past months) =====
      - name: Read historical c (construct) data from size-c.json
        id: read-size-c
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: read
          filename: dump/size-c.json
          field: ${{ steps.set-month.outputs.month }}.ETAG

      # æ ¸å¿ƒæ”¹3ï¼šå…ˆè¯»å–å†å²ETagï¼Œå¯¹æ¯”åå†³å®šæ˜¯å¦ä¸‹è½½/å–æ¶ˆå·¥ä½œæµ
      - name: Check ETag change before download
        id: pre-check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          mkdir -p dump # ç¡®ä¿dumpç›®å½•å­˜åœ¨

          # åˆå§‹åŒ–å˜æ›´æ ‡è®°
          d_changed="true"
          c_changed="true"
          # åˆå§‹åŒ–å†å²ETagå˜é‡ (from JSON instead of TXT)
          HIST_DEVELOP_ETAG="${{ steps.read-size-d.outputs.value }}"
          HIST_CONSTRU_ETAG="${{ steps.read-size-c.outputs.value }}"

          echo "======= è¯»å–å†å² size-d.json/size-c.jsonï¼ˆc/d åˆ†å¼€ï¼‰======="
          echo "å†å² d${MONTH} ETag: $HIST_DEVELOP_ETAG"
          echo "å†å² c${MONTH} ETag: $HIST_CONSTRU_ETAG"

          # ===== åˆ†å¼€åˆ¤æ–­ d çš„ ETagï¼ˆä»…è¯»å–æˆåŠŸæ—¶æ‰å¯¹æ¯”ï¼‰=====
          echo "--- å¯¹æ¯” develop ETag ---"
          if [ "${{ steps.get-etag.outputs.DEVELOP_ETAG_STATUS }}" = "success" ] && [ -n "$HIST_DEVELOP_ETAG" ] && [ -n "${{ steps.get-etag.outputs.DEVELOP_ETAG }}" ]; then
            if [ "${{ steps.get-etag.outputs.DEVELOP_ETAG }}" = "$HIST_DEVELOP_ETAG" ]; then
              d_changed="false"
              echo "develop ETag å®Œå…¨ä¸€è‡´ï¼Œæ— æ›´æ–°"
            else
              d_changed="true"
              echo "develop ETag ä¸ä¸€è‡´ï¼ˆå†å²ï¼š$HIST_DEVELOP_ETAG | æœ€æ–°ï¼š${{ steps.get-etag.outputs.DEVELOP_ETAG }}ï¼‰"
            fi
          else
            d_changed="true"
            echo "develop ETag è¯»å–å¤±è´¥/å†å²ä¸å­˜åœ¨ï¼Œåˆ¤å®šä¸ºæœ‰æ›´æ–°"
          fi

          # ===== åˆ†å¼€åˆ¤æ–­ c çš„ ETagï¼ˆä»…è¯»å–æˆåŠŸæ—¶æ‰å¯¹æ¯”ï¼‰=====
          echo "--- å¯¹æ¯” construct ETag ---"
          if [ "${{ steps.get-etag.outputs.CONSTRU_ETAG_STATUS }}" = "success" ] && [ -n "$HIST_CONSTRU_ETAG" ] && [ -n "${{ steps.get-etag.outputs.CONSTRU_ETAG }}" ]; then
            if [ "${{ steps.get-etag.outputs.CONSTRU_ETAG }}" = "$HIST_CONSTRU_ETAG" ]; then
              c_changed="false"
              echo "construct ETag å®Œå…¨ä¸€è‡´ï¼Œæ— æ›´æ–°"
            else
              c_changed="true"
              echo "construct ETag ä¸ä¸€è‡´ï¼ˆå†å²ï¼š$HIST_CONSTRU_ETAG | æœ€æ–°ï¼š${{ steps.get-etag.outputs.CONSTRU_ETAG }}ï¼‰"
            fi
          else
            c_changed="true"
            echo "construct ETag è¯»å–å¤±è´¥/å†å²ä¸å­˜åœ¨ï¼Œåˆ¤å®šä¸ºæœ‰æ›´æ–°"
          fi

          # è¾“å‡ºå˜æ›´æ ‡è®°åˆ°GitHubå˜é‡
          echo "d_changed=$d_changed" >> $GITHUB_OUTPUT
          echo "c_changed=$c_changed" >> $GITHUB_OUTPUT
          # è¾“å‡ºæ•´ä½“å˜æ›´æ ‡è®°ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          if [ "$d_changed" = "false" ] && [ "$c_changed" = "false" ]; then
            echo "æ•´ä½“æ— å˜æ›´ï¼ˆc/d ETag å‡ä¸€è‡´ï¼‰"
          else
            echo "æ•´ä½“æœ‰å˜æ›´ï¼ˆc/d è‡³å°‘ä¸€ä¸ªæœ‰å˜åŒ–ï¼‰"
          fi

      # ä¿®å¤3ï¼šç¬¬ä¸€æ¬¡å–æ¶ˆå·¥ä½œæµï¼ˆä»… c/d ETag å‡æ— å˜åŒ–æ—¶æ‰§è¡Œï¼‰
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆETagæ— å˜åŒ–ï¼‰
        if: steps.pre-check.outputs.d_changed == 'false' && steps.pre-check.outputs.c_changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½æ–‡ä»¶ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      # æ ¸å¿ƒæ”¹5ï¼šä»…ETagå˜åŒ–æ—¶æ‰ä¸‹è½½æ–‡ä»¶ + è‡ªæ£€æ–‡ä»¶å­˜åœ¨æ€§
      - name: Download c*.gz (only if c ETag changed)
        if: steps.pre-check.outputs.d_changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½ createitemrecords.gz ======="
          curl -s -o develop.gz https://api.poi.moe/dump/createitemrecords.gz
          # è‡ªæ£€ï¼šæ–‡ä»¶ä¸å­˜åœ¨ç›´æ¥exit 2
          if [ ! -f "develop.gz" ]; then
            echo "âŒ develop.gzä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          fi
          # è®¡ç®—MD5 + è‡ªæ£€ç©ºå€¼
          MD5_DEVELOP_GZ=$(md5sum develop.gz | awk '{print $1}')
          if [ -z "$MD5_DEVELOP_GZ" ] || [ "$MD5_DEVELOP_GZ" = "N/A" ]; then
            echo "âŒ develop.gz MD5 ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          fi
          echo "âœ… develop.gz æœ€æ–°MD5: '$MD5_DEVELOP_GZ'"

      - name: Download d*.gz (only if d ETag changed)
        if: steps.pre-check.outputs.c_changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½ createshiprecords.gz ======="
          curl -s -o construct.gz https://api.poi.moe/dump/createshiprecords.gz
          # è‡ªæ£€ï¼šæ–‡ä»¶ä¸å­˜åœ¨ç›´æ¥exit 2
          if [ ! -f "construct.gz" ]; then
            echo "âŒ construct.gzä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          fi
          # è®¡ç®—MD5 + è‡ªæ£€ç©ºå€¼
          MD5_CONSTRU_GZ=$(md5sum construct.gz | awk '{print $1}')
          if [ -z "$MD5_CONSTRU_GZ" ] || [ "$MD5_CONSTRU_GZ" = "N/A" ]; then
            echo "âŒ construct.gz MD5 ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
            exit 2
          fi
          echo "âœ… construct.gz æœ€æ–°MD5: '$MD5_CONSTRU_GZ'"

      - name: Check if changed
        id: check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          # å¤ç”¨ pre-check çš„ç»“æœï¼Œåˆå§‹åŒ–æ•´ä½“å˜æ›´æ ‡è®°
          d_changed="${{ steps.pre-check.outputs.d_changed }}"
          c_changed="${{ steps.pre-check.outputs.c_changed }}"
          echo "changed=$([ "$d_changed" = "true" ] || [ "$c_changed" = "true" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          
          if [ "$d_changed" = "false" ] && [ "$c_changed" = "false" ]; then
            exit 0 # æ— å˜åŒ–æ—¶ç›´æ¥é€€å‡ºï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
          fi

          # å®šä¹‰æœˆä»½å˜é‡ï¼ˆé¿å…åµŒå¥—å¼•ç”¨é—®é¢˜ï¼‰
          MONTH="${{ steps.set-month.outputs.month }}"
          D_HISTORY_GZ_FILE="dump/c${MONTH}.gz"
          C_HISTORY_GZ_FILE="dump/d${MONTH}.gz"
          
          echo "======= æ‰“å°ETagå†…å®¹ ======="
          # æ‹¼æ¥æœ€æ–°ETagï¼ˆä¿ç•™åŸæœ‰å˜é‡åï¼Œæœ€å°åŒ–æ”¹åŠ¨ï¼‰
          DEVELOP_ETAG="ETag: ${{ steps.get-etag.outputs.DEVELOP_ETAG }}"
          CONSTRU_ETAG="ETag: ${{ steps.get-etag.outputs.CONSTRU_ETAG }}"
          echo "develop ETag (æ¸…ç†å): $DEVELOP_ETAG"
          echo "construct ETag (æ¸…ç†å): $CONSTRU_ETAG"
          
          echo "======= æ‰“å°æ–‡ä»¶MD5å€¼ ======="
          # ===== åˆ†å¼€å¤„ç† d*.gzï¼ˆMD5 æ£€æŸ¥ï¼Œç¬¬äºŒæ¬¡å–æ¶ˆçš„åŸºç¡€ï¼‰=====
          MD5_DEVELOP_GZ="N/A"
          DEVELOP_SIZE="N/A"
          if [ "$d_changed" = "true" ] && [ -f "develop.gz" ]; then
            MD5_DEVELOP_GZ=$(md5sum develop.gz | awk '{print $1}')
            # äºŒæ¬¡è‡ªæ£€ï¼šMD5ä¸ºç©ºexit 2
            if [ -z "$MD5_DEVELOP_GZ" ]; then
              echo "âŒ develop.gz MD5 ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
              exit 2
            fi
            echo "âœ… develop.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_DEVELOP_GZ"
            # ç§»åŠ¨æ–‡ä»¶ + è®¡ç®—å¤§å°
            mv develop.gz "$D_HISTORY_GZ_FILE"
            # è®¡ç®— develop æ–‡ä»¶å¤§å°
            DEVELOP_SIZE=$(du -k "$D_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $D_HISTORY_GZ_FILE å¤§å°: ${DEVELOP_SIZE} KB"
          elif [ "$d_changed" = "false" ]; then
            echo "âœ… develop.gz æ— å˜åŒ–ï¼Œè·³è¿‡ MD5 è®¡ç®—"
          else
            echo "âŒ develop.gz æ–‡ä»¶ä¸å­˜åœ¨"
            exit 2
          fi

          # ===== åˆ†å¼€å¤„ç† c*.gzï¼ˆMD5 æ£€æŸ¥ï¼Œç¬¬äºŒæ¬¡å–æ¶ˆçš„åŸºç¡€ï¼‰=====
          MD5_CONSTRU_GZ="N/A"
          CONSTRU_SIZE="N/A"
          if [ "$c_changed" = "true" ] && [ -f "construct.gz" ]; then
            MD5_CONSTRU_GZ=$(md5sum construct.gz | awk '{print $1}')
            # äºŒæ¬¡è‡ªæ£€ï¼šMD5ä¸ºç©ºexit 2
            if [ -z "$MD5_CONSTRU_GZ" ]; then
              echo "âŒ construct.gz MD5 ä¸ºç©ºï¼Œç»ˆæ­¢æµç¨‹"
              exit 2
            fi
            echo "âœ… construct.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_CONSTRU_GZ"
            # ç§»åŠ¨ construct.gz åˆ°ç›®æ ‡è·¯å¾„
            mv construct.gz "$C_HISTORY_GZ_FILE"
            # è®¡ç®— construct æ–‡ä»¶å¤§å°
            CONSTRU_SIZE=$(du -k "$C_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $C_HISTORY_GZ_FILE å¤§å°: ${CONSTRU_SIZE} KB"
            # å¯¼å‡ºå˜é‡ä¾›JSONå†™å…¥ä½¿ç”¨
            echo "MD5_DEVELOP_GZ=$MD5_DEVELOP_GZ" >> $GITHUB_ENV
            echo "DEVELOP_SIZE=$DEVELOP_SIZE" >> $GITHUB_ENV
            echo "MD5_CONSTRU_GZ=$MD5_CONSTRU_GZ" >> $GITHUB_ENV
            echo "CONSTRU_SIZE=$CONSTRU_SIZE" >> $GITHUB_ENV
            echo "CHECK_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
            elif [ "$c_changed" = "false" ]; then
            echo "âœ… construct.gz æ— å˜åŒ–ï¼Œè·³è¿‡ MD5 è®¡ç®—"
          else
            echo "âŒ construct.gz æ–‡ä»¶ä¸å­˜åœ¨"
            exit 2
          fi

          # ====================== åŸæœ‰é€»è¾‘ï¼šè¾“å‡ºæœ€ç»ˆç»“è®º ======================
          echo -e "\n======= ã€æ ¸å¿ƒã€‘æœ€ç»ˆåˆ¤å®š ======="
          echo "ğŸ“Œ æœ€ç»ˆç»“è®ºï¼šData updated! Saving new .gz (ETag/MD5å‡å˜åŒ–)"

      # æ–°å¢ï¼šWrite current month data to JSON (replace TXT, preserve historical data)
      - name: Write d${{ steps.set-month.outputs.month }} data to JSON
        if: steps.pre-check.outputs.d_changed == 'true'
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: write
          filename: dump/size-d.json
          field: ${{ steps.set-month.outputs.month }}
          value: |
            {
              "ETAG": "${{ steps.get-etag.outputs.DEVELOP_ETAG }}",
              "MD5": "${{ env.MD5_DEVELOP_GZ }}",
              "SizeKB": "${{ env.DEVELOP_SIZE }}",
              "CheckTime": "${{ env.CHECK_TIME }}"
            }

      # ===== NEW: Write c (construct) data to size-c.json (preserve past months) =====
      - name: Write c (construct) data to size-c.json
        if: steps.pre-check.outputs.c_changed == 'true'
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: write
          filename: dump/size-c.json
          field: ${{ steps.set-month.outputs.month }}
          value: |
            {
              "ETAG": "${{ steps.get-etag.outputs.CONSTRU_ETAG }}",
              "MD5": "${{ env.MD5_CONSTRU_GZ }}",
              "SizeKB": "${{ env.CONSTRU_SIZE }}",
              "CheckTime": "${{ env.CHECK_TIME }}"
            }

      # ä¿®å¤5ï¼šç¬¬äºŒæ¬¡å–æ¶ˆå·¥ä½œæµï¼ˆMD5 æ— å˜åŒ–ï¼Œc/d å‡æ— æ›´æ–°æ—¶æ‰§è¡Œï¼‰
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆMD5 æ— å˜åŒ–ï¼Œc/d å‡æ— æ›´æ–°ï¼‰
        if: steps.check.outputs.changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'MD5 æ— å˜åŒ–ï¼ˆc/d å‡ä¸€è‡´ï¼‰ï¼Œæ— éœ€æäº¤ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      - name: Commit and push .gz if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git lfs track "drop*.gz"
          git add dump/
          # æäº¤ä¿¡æ¯åŒ…å« c/d å˜æ›´çŠ¶æ€
          COMMIT_MSG="Update "
          if [ "${{ steps.pre-check.outputs.d_changed }}" = "true" ]; then
            COMMIT_MSG+="construct "
          fi
          if [ "${{ steps.pre-check.outputs.c_changed }}" = "true" ]; then
            COMMIT_MSG+="develop "
          fi
          COMMIT_MSG+="${{ steps.set-month.outputs.month }}.gz"
          git commit -m "$COMMIT_MSG"
          git push --force-with-lease