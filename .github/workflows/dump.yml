name: dump

on:
  push:
    paths:
      - '**.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘  push:

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      month: ${{ steps.set-month.outputs.month }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set current month
        id: set-month
        run: echo "month=$(date +%Y-%m)" >> $GITHUB_OUTPUT

      - name: Download creates .gz and ETag
        run: |
          curl -s -o creates.gz https://api.poi.moe/dump/createitemrecords.gz
          curl -s -I https://api.poi.moe/dump/createitemrecords.gz | grep -i etag > glance.txt || true
          curl -s -o drops.gz https://api.poi.moe/dump/dropshiprecords.gz
          curl -s -I https://api.poi.moe/dump/dropshiprecords.gz | grep -i etag >> glance.txt || true

      - name: Check if changed
        id: check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          # å®šä¹‰æœˆä»½å˜é‡ï¼ˆé¿å…åµŒå¥—å¼•ç”¨é—®é¢˜ï¼‰
          MONTH="${{ steps.set-month.outputs.month }}"
          # å®šä¹‰å†å²æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºMD5å¯¹æ¯”ï¼‰
          HISTORY_GZ_FILE="dump/c-${MONTH}.gz"
          HISTORY_ETAG_FILE="dump/last_etag.txt"
          
          echo "======= æ‰“å°ETagå†…å®¹ ======="
          if [ -f "glance.txt" ]; then
            CREATES_ETAG=$(cat glance.txt | tr -d ' \n\r')  # æ¸…ç†ç©ºæ ¼/æ¢è¡Œ
            echo "glance.txt (æ¸…ç†å): $CREATES_ETAG"
          else
            CREATES_ETAG=""
            echo "glance.txt æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          if [ -f "$HISTORY_ETAG_FILE" ]; then
            LAST_ETAG=$(cat "$HISTORY_ETAG_FILE" | tr -d ' \n\r')  # æ¸…ç†ç©ºæ ¼/æ¢è¡Œ
            echo "dump/last_etag.txt (æ¸…ç†å): $LAST_ETAG"
          else
            LAST_ETAG=""
            echo "dump/last_etag.txt æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          echo "======= æ‰“å°æ–‡ä»¶MD5å€¼ ======="
          # æ‰“å°æœ€æ–°æ–‡ä»¶ MD5
          if [ -f "creates.gz" ]; then
            MD5_CREATES_GZ=$(md5sum creates.gz | awk '{print $1}')
            echo "âœ… creates.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_CREATES_GZ"
          else
            echo "creates.gz æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡MD5è®¡ç®—"
            MD5_CREATES="N/A"
          fi

          # æ‰“å°å†å².gzæ–‡ä»¶ MD5ï¼ˆå¦ä¸€ä¸ªå…³é”®æ–‡ä»¶ï¼‰
          if [ -f "$HISTORY_GZ_FILE" ]; then
            MD5_HISTORY_GZ=$(md5sum "$HISTORY_GZ_FILE" | awk '{print $1}')
            # è·å–å†å²æ–‡ä»¶å¤§å°ï¼ˆKBï¼‰ï¼Œä¿ç•™æ•´æ•°
            FILE_SIZE_KB=$(du -k "$HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $HISTORY_GZ_FILE (å†å²æ–‡ä»¶) å¤§å°: ${FILE_SIZE_KB} KB"
            echo "âœ… $HISTORY_GZ_FILE (å†å²æ–‡ä»¶) MD5: $MD5_HISTORY_GZ"
            echo "MD5_HISTORY_GZ: $MD5_HISTORY_GZ" >> glance.txt
            echo "FILE_SIZE_KB: $FILE_SIZE_KB" >> glance.txt
          else
            MD5_HISTORY_GZ="N/A"
            echo "âŒ $HISTORY_GZ_FILE: ä¸å­˜åœ¨"
          fi

          if [ -f "$HISTORY_ETAG_FILE" ]; then
            MD5_HISTORY_ETAG=$(md5sum "$HISTORY_ETAG_FILE" | awk '{print $1}')
            echo "âœ… $HISTORY_ETAG_FILE MD5: $MD5_HISTORY_ETAG"
          else
            MD5_HISTORY_ETAG="N/A"
            echo "âŒ $HISTORY_ETAG_FILE: ä¸å­˜åœ¨"
          fi

          # ====================== 3. ä¿®å¤ETagåˆ¤æ–­é€»è¾‘ï¼ˆåŒé‡æ ¡éªŒï¼šæ–‡ä»¶å­˜åœ¨+å­—ç¬¦ä¸²å®Œå…¨ç›¸ç­‰ï¼‰ ======================
          echo -e "\n======= ã€æ ¸å¿ƒã€‘ETag å¯¹æ¯”åˆ¤æ–­ ======="
          # åˆå§‹åŒ–å˜æ›´æ ‡è®°
          CHANGED="false"
          
          # åŒé‡æ ¡éªŒï¼š1.å†å²ETagæ–‡ä»¶å­˜åœ¨ 2.ETagå­—ç¬¦ä¸²å®Œå…¨ç›¸ç­‰
          if [ -n "$LAST_ETAG" ] && [ -n "$CREATES_ETAG" ] && [ "$LAST_ETAG" = "$CREATES_ETAG" ]; then
            echo "âœ… ETag å®Œå…¨ä¸€è‡´ï¼ˆ$LAST_ETAGï¼‰ï¼Œæ— æ›´æ–°"
            CHANGED="false"
          else
            echo "âŒ ETag ä¸ä¸€è‡´/æ–‡ä»¶ç¼ºå¤± â†’ åˆ¤å®šä¸ºæœ‰æ›´æ–°"
            echo "   å†å²ETag: $LAST_ETAG"
            echo "   æœ€æ–°ETag: $CREATES_ETAG"
            CHANGED="true"
          fi

          # è¾“å‡ºåˆ°GitHubå˜é‡
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

          # ====================== 4. æ‰§è¡Œæ–‡ä»¶æ›´æ–°/è·³è¿‡é€»è¾‘ ======================
          if [ "$CHANGED" = "false" ]; then
            echo -e "\nğŸ“Œ æœ€ç»ˆç»“è®ºï¼šNo update today. (ETagæ— å˜åŒ–)"
          else
            echo -e "\nğŸ“Œ æœ€ç»ˆç»“è®ºï¼šData updated! Saving new .gz (ETagå·²å˜åŒ–)"
            mkdir -p dump 
            # ç§»åŠ¨æœ€æ–°.gzæ–‡ä»¶
            mv creates.gz "$HISTORY_GZ_FILE"
            # ç§»åŠ¨åæ‰“å°æ–°æ–‡ä»¶çš„MD5
            if [ -f "$HISTORY_GZ_FILE" ]; then
              MD5_NEW_GZ=$(md5sum "$HISTORY_GZ_FILE" | awk '{print $1}')
              echo "âœ… ç§»åŠ¨å $HISTORY_GZ_FILE MD5: $MD5_NEW_GZ"
            fi
            # ç§»åŠ¨ETagæ–‡ä»¶
            mv glance.txt "$HISTORY_ETAG_FILE"
          fi

      - name: å–æ¶ˆå·¥ä½œæµï¼ˆæ— ä»£ç å˜æ›´ï¼‰
        if: steps.check.outputs.changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0 # Replace with your repo/version
        with:
          cancel-reason: 'æ— ä»£ç å˜æ›´ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      - name: Commit and push .gz if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dump/
          git commit -m "Update createitemrecords ${{ steps.set-month.outputs.month }}.gz"
          git push
