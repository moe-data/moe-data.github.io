name: dump

on:
  push:
    paths:
      - '**.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘  push:

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      month: ${{ steps.set-month.outputs.month }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set current month
        id: set-month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹1ï¼šå®‰è£…Git LFSï¼ˆç”¨äºæ¨é€gzæ–‡ä»¶ï¼‰
      - name: Install Git LFS
        run: |
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          # è·Ÿè¸ªæ‰€æœ‰.gzæ–‡ä»¶ï¼ˆé…ç½®Git LFSï¼‰
          git lfs track "*.gz"

      # æ ¸å¿ƒæ”¹2ï¼šå…ˆä»…è·å–ETagï¼ˆä¸ä¸‹è½½æ–‡ä»¶ï¼‰ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
      - name: Get ETag only (no file download)
        id: get-etag
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          echo "======= ã€å‰ç½®ã€‘ä»…è·å–ETag + è‡ªæ£€ ======="
          
          # åˆå§‹åŒ–ETagå˜é‡+è‡ªæ£€æ ‡è®°
          CREATES_ETAG=""
          DROPS_ETAG=""
          ETAG_GET_SUCCESS="true"

          # è·å–createsçš„ETag
          CREATES_RESP=$(curl -s -I -w "%{http_code}" https://api.poi.moe/dump/createitemrecords.gz)
          CREATES_HTTP_CODE=$(echo "$CREATES_RESP" | tail -n1)
          CREATES_ETAG=$(echo "$CREATES_RESP" | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}')
          
          # è‡ªæ£€ï¼šHTTPç é200 æˆ– ETagä¸ºç©º â†’ è¯»å–å¤±è´¥
          if [ "$CREATES_HTTP_CODE" != "200" ] || [ -z "$CREATES_ETAG" ]; then
            echo "âŒ creates ETagè¯»å–å¤±è´¥ï¼HTTPç : $CREATES_HTTP_CODE, ETagå€¼: '$CREATES_ETAG'"
            ETAG_GET_SUCCESS="false"
          else
            echo "âœ… createsæœ€æ–°ETag: $CREATES_ETAG"
          fi

          # è·å–dropsçš„ETag + æ£€æŸ¥curlè¿”å›ç 
          DROPS_RESP=$(curl -s -I -w "%{http_code}" https://api.poi.moe/dump/dropshiprecords.gz)
          DROPS_HTTP_CODE=$(echo "$DROPS_RESP" | tail -n1)
          DROPS_ETAG=$(echo "$DROPS_RESP" | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}')
          
          # è‡ªæ£€ï¼šHTTPç é200 æˆ– ETagä¸ºç©º â†’ è¯»å–å¤±è´¥
          if [ "$DROPS_HTTP_CODE" != "200" ] || [ -z "$DROPS_ETAG" ]; then
            echo "âŒ drops ETagè¯»å–å¤±è´¥ï¼HTTPç : $DROPS_HTTP_CODE, ETagå€¼: '$DROPS_ETAG'"
            ETAG_GET_SUCCESS="false"
          else
            echo "âœ… dropsæœ€æ–°ETag: $DROPS_ETAG"
          fi

          # è¾“å‡ºå˜é‡ï¼ˆå«è‡ªæ£€ç»“æœï¼‰
          echo "CREATES_ETAG=$CREATES_ETAG" >> $GITHUB_OUTPUT
          echo "DROPS_ETAG=$DROPS_ETAG" >> $GITHUB_OUTPUT
          echo "ETAG_GET_SUCCESS=$ETAG_GET_SUCCESS" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹3ï¼šå…ˆè¯»å–å†å²ETagï¼Œå¯¹æ¯”åå†³å®šæ˜¯å¦ä¸‹è½½/å–æ¶ˆå·¥ä½œæµ
      - name: Check ETag change before download
        id: pre-check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          mkdir -p dump # ç¡®ä¿dumpç›®å½•å­˜åœ¨

          # åˆå§‹åŒ–å˜æ›´æ ‡è®°
          CHANGED="false"
          # åˆå§‹åŒ–å†å²ETagå˜é‡
          HIST_CREATES_ETAG=""
          HIST_DROPS_ETAG=""

          # è¯»å–monthly_size.txtä¸­çš„å†å²ETagï¼ˆé”®å€¼æ ¼å¼ï¼‰
          if [ -f "$MONTHLY_SIZE_FILE" ]; then
            echo "======= è¯»å–å†å²monthly_size.txt ======="
            # æå–c{å¹´æœˆ}_ETagçš„å€¼
            HIST_CREATES_ETAG=$(grep -E "^c${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            # æå–d{å¹´æœˆ}_ETAGçš„å€¼
            HIST_DROPS_ETAG=$(grep -E "^d${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            echo "å†å²c${MONTH} ETag: $HIST_CREATES_ETAG"
            echo "å†å²d${MONTH} ETag: $HIST_DROPS_ETAG"
          else
            echo "======= monthly_size.txtä¸å­˜åœ¨ï¼Œé¦–æ¬¡æ‰§è¡Œ ======="
          fi

          # æ ¸å¿ƒä¿®å¤ï¼šETagè¯»å–å¤±è´¥ â†’ åˆ¤å®šä¸ºæœ‰å˜åŒ–ï¼›å¦åˆ™å¯¹æ¯”ETag
          if [ "${{ steps.get-etag.outputs.ETAG_GET_SUCCESS }}" = "false" ]; then
            echo "======= ETagè¯»å–å¤±è´¥ï¼Œåˆ¤å®šä¸ºæœ‰å˜åŒ– ======="
            CHANGED="true"
          else
            # å¯¹æ¯”ETagï¼ˆä»»ä¸€å˜åŒ–åˆ™åˆ¤å®šä¸ºæœ‰æ›´æ–°ï¼‰
            if [ "${{ steps.get-etag.outputs.CREATES_ETAG }}" != "$HIST_CREATES_ETAG" ] || [ "${{ steps.get-etag.outputs.DROPS_ETAG }}" != "$HIST_DROPS_ETAG" ]; then
              echo "======= ETagæœ‰å˜åŒ–ï¼Œå‡†å¤‡ä¸‹è½½æ–‡ä»¶ ======="
              echo "creates: å†å²['$HIST_CREATES_ETAG'] â‰  æœ€æ–°['${{ steps.get-etag.outputs.CREATES_ETAG }}']"
              echo "drops: å†å²['$HIST_DROPS_ETAG'] â‰  æœ€æ–°['${{ steps.get-etag.outputs.DROPS_ETAG }}']"
              CHANGED="true"
            else
              echo "======= ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½ ======="
              CHANGED="false"
            fi
          fi

          # è¾“å‡ºå˜æ›´æ ‡è®°åˆ°GitHubå˜é‡
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹4ï¼šETagæ— å˜åŒ–æ—¶ç›´æ¥å–æ¶ˆå·¥ä½œæµï¼Œé¿å…ä¸‹è½½å¼€é”€
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆETagæ— å˜åŒ–ï¼‰
        if: steps.pre-check.outputs.changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½æ–‡ä»¶ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      # æ ¸å¿ƒæ”¹5ï¼šä»…ETagå˜åŒ–æ—¶æ‰ä¸‹è½½æ–‡ä»¶
      - name: Download .gz files (only if ETag changed)
        if: steps.pre-check.outputs.changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½æ–‡ä»¶ ======="
          # ä¸‹è½½creates.gz
          curl -s -o creates.gz https://api.poi.moe/dump/createitemrecords.gz || { echo "âŒ creates.gzä¸‹è½½å¤±è´¥"; exit 1; }
          curl -s -o drops.gz https://api.poi.moe/dump/dropshiprecords.gz || { echo "âŒ drops.gzä¸‹è½½å¤±è´¥"; exit 1; }
          # è‡ªæ£€ï¼šæ–‡ä»¶å¤§å°æ˜¯å¦ä¸º0
          if [ ! -s creates.gz ] || [ ! -s drops.gz ]; then
            echo "âŒ ä¸‹è½½çš„.gzæ–‡ä»¶ä¸ºç©ºï¼Œé€€å‡º"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ"

      # æ ¸å¿ƒæ”¹5ï¼šMD5æ£€æŸ¥ + ç¬¬äºŒæ¬¡å–æ¶ˆå·¥ä½œæµ
      - name: Check MD5 change (Self-Check)
        id: md5-check
        if: steps.pre-check.outputs.changed == 'true'
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          C_HISTORY_GZ_FILE="dump/c${MONTH}.gz"
          D_HISTORY_GZ_FILE="dump/d${MONTH}.gz"

          # åˆå§‹åŒ–MD5æ£€æŸ¥æ ‡è®°
          MD5_CHANGED="false"
          HIST_CREATES_MD5=""
          HIST_DROPS_MD5=""

          echo "======= ã€MD5æ£€æŸ¥ã€‘è¯»å–å†å²MD5 ======="
          # è¯»å–å†å²MD5
          if [ -f "$MONTHLY_SIZE_FILE" ]; then
            HIST_CREATES_MD5=$(grep -E "^c${MONTH}_MD5=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            HIST_DROPS_MD5=$(grep -E "^d${MONTH}_MD5=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            echo "å†å²c${MONTH} MD5: '$HIST_CREATES_MD5'"
            echo "å†å²d${MONTH} MD5: '$HIST_DROPS_MD5'"
          fi

          echo "======= ã€MD5æ£€æŸ¥ã€‘è®¡ç®—æœ€æ–°MD5 ======="
          # è®¡ç®—æœ€æ–°MD5 + è‡ªæ£€
          if [ -f "creates.gz" ]; then
            MD5_CREATES_GZ=$(md5sum creates.gz | awk '{print $1}')
            echo "âœ… creates.gz æœ€æ–°MD5: '$MD5_CREATES_GZ'"
          else
            echo "âŒ creates.gzä¸å­˜åœ¨ï¼ŒMD5æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          if [ -f "drops.gz" ]; then
            MD5_DROPS_GZ=$(md5sum drops.gz | awk '{print $1}')
            echo "âœ… drops.gz æœ€æ–°MD5: '$MD5_DROPS_GZ'"
          else
            echo "âŒ drops.gzä¸å­˜åœ¨ï¼ŒMD5æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

          # å¯¹æ¯”MD5ï¼ˆä»»ä¸€å˜åŒ–åˆ™åˆ¤å®šä¸ºæœ‰æ›´æ–°ï¼‰
          if [ "$MD5_CREATES_GZ" != "$HIST_CREATES_MD5" ] || [ "$MD5_DROPS_GZ" != "$HIST_DROPS_MD5" ]; then
            echo "======= MD5æœ‰å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–°æ–‡ä»¶ ======="
            echo "creates: å†å²['$HIST_CREATES_MD5'] â‰  æœ€æ–°['$MD5_CREATES_GZ']"
            echo "drops: å†å²['$HIST_DROPS_MD5'] â‰  æœ€æ–°['$MD5_DROPS_GZ']"
            MD5_CHANGED="true"
          else
            echo "======= MD5æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–° ======="
            MD5_CHANGED="false"
          fi

          # è¾“å‡ºå˜é‡
          echo "md5_changed=$MD5_CHANGED" >> $GITHUB_OUTPUT
          # ä¼ é€’æœ€æ–°MD5ä¾›åç»­ä½¿ç”¨
          echo "md5_creates=$MD5_CREATES_GZ" >> $GITHUB_OUTPUT
          echo "md5_drops=$MD5_DROPS_GZ" >> $GITHUB_OUTPUT

      # ç¬¬äºŒæ¬¡å–æ¶ˆï¼šMD5æ— å˜åŒ– â†’ å–æ¶ˆå·¥ä½œæµ
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆMD5æ— å˜åŒ–ï¼‰
        if: steps.md5-check.outputs.md5_changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'MD5æ— å˜åŒ–ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      - name: Check if changed
        id: check
        if: steps.md5-check.outputs.md5_changed == 'true'
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          echo "changed=true" >> $GITHUB_OUTPUT
          MONTH="${{ steps.set-month.outputs.month }}"
          C_HISTORY_GZ_FILE="dump/c${MONTH}.gz"
          D_HISTORY_GZ_FILE="dump/d${MONTH}.gz"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          
          echo "======= æ‰“å°ETagå†…å®¹ ======="
          # æ‹¼æ¥æœ€æ–°ETagï¼ˆä¿ç•™åŸæœ‰å˜é‡åï¼Œæœ€å°åŒ–æ”¹åŠ¨ï¼‰
          CREATES_ETAG="ETag: ${{ steps.get-etag.outputs.CREATES_ETAG }}"
          DROPS_ETAG="ETag: ${{ steps.get-etag.outputs.DROPS_ETAG }}"
          echo "creates ETag (æ¸…ç†å): $CREATES_ETAG"
          echo "drops ETag (æ¸…ç†å): $DROPS_ETAG"
          
          echo "======= æ‰“å°æ–‡ä»¶MD5å€¼ ======="
          # ç§»åŠ¨æ–‡ä»¶ + è®¡ç®—å¤§å°
          mv creates.gz "$C_HISTORY_GZ_FILE"
          mv drops.gz "$D_HISTORY_GZ_FILE"
          # è‡ªæ£€ï¼šæ–‡ä»¶ç§»åŠ¨åæ˜¯å¦å­˜åœ¨
          if [ ! -f "$C_HISTORY_GZ_FILE" ] || [ ! -f "$D_HISTORY_GZ_FILE" ]; then
            echo "âŒ æ–‡ä»¶ç§»åŠ¨å¤±è´¥ï¼Œé€€å‡º"
            exit 1
          fi
          C_FILE_SIZE_KB=$(du -k "$C_HISTORY_GZ_FILE" | awk '{print $1}')
          D_FILE_SIZE_KB=$(du -k "$D_HISTORY_GZ_FILE" | awk '{print $1}')
          echo "âœ… $C_HISTORY_GZ_FILE å¤§å°: ${C_FILE_SIZE_KB} KB"
          echo "âœ… $D_HISTORY_GZ_FILE å¤§å°: ${D_FILE_SIZE_KB} KB"

          # ====================== æ ¸å¿ƒæ”¹7ï¼šå†™å…¥monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰ ======================
          echo "======= å†™å…¥monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰ ======="
          # è·å–å½“å‰æ£€æŸ¥æ—¶é—´ï¼ˆISOæ ¼å¼ï¼Œæ–¹ä¾¿è§£æï¼‰
          CHECK_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # å…ˆåˆ é™¤å½“å‰æœˆä»½çš„æ—§è®°å½•ï¼ˆé¿å…é‡å¤ï¼‰
          grep -v -E "^[cd]${MONTH}_" "$MONTHLY_SIZE_FILE" > "$MONTHLY_SIZE_FILE.tmp" 2>/dev/null || true
          # å†™å…¥createsçš„é”®å€¼
          echo "c${MONTH}_ETAG=\"${{ steps.get-etag.outputs.CREATES_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_MD5=\"${{ steps.md5-check.outputs.md5_creates }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_SizeKB=\"${C_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          # å†™å…¥dropsçš„é”®å€¼
          echo "d${MONTH}_ETAG=\"${{ steps.get-etag.outputs.DROPS_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_MD5=\"${{ steps.md5-check.outputs.md5_drops }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_SizeKB=\"${D_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          # æ›¿æ¢åŸæ–‡ä»¶
          mv "$MONTHLY_SIZE_FILE.tmp" "$MONTHLY_SIZE_FILE"
          
          # æ‰“å°å†™å…¥ç»“æœ
          echo "âœ… monthly_size.txt å†™å…¥å®Œæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
          cat "$MONTHLY_SIZE_FILE"

          # ====================== åŸæœ‰é€»è¾‘ï¼šè¾“å‡ºæœ€ç»ˆç»“è®º ======================
          echo -e "\n======= ã€æ ¸å¿ƒã€‘æœ€ç»ˆåˆ¤å®š ======="
          echo "ğŸ“Œ æœ€ç»ˆç»“è®ºï¼šData updated! Saving new .gz (ETag/MD5å‡å˜åŒ–)"

      - name: Commit and push .gz if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git lfs track "*.gz"
          git add dump/
          git commit -m "Update createitemrecords/dropshiprecords ${{ steps.set-month.outputs.month }}.gz"
          git push --force-with-lease
