name: dump

on:
  push:
    paths:
      - '**.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘  push:

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      month: ${{ steps.set-month.outputs.month }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set current month
        id: set-month
        # æ ¸å¿ƒæ”¹1ï¼šæœˆä»½æ ¼å¼ä» 2026-01 æ”¹ä¸º 202601
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹2ï¼šå…ˆä»…è·å–ETagï¼ˆä¸ä¸‹è½½æ–‡ä»¶ï¼‰ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
      - name: Get ETag only (no file download)
        id: get-etag
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          # è·å–createsçš„ETag
          CREATES_ETAG=$(curl -s -I https://api.poi.moe/dump/createitemrecords.gz | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}')
          echo "CREATES_ETAG=$CREATES_ETAG" >> $GITHUB_OUTPUT
          # è·å–dropsçš„ETag
          DROPS_ETAG=$(curl -s -I https://api.poi.moe/dump/dropshiprecords.gz | grep -i etag | tr -d ' \n\r' | awk -F': ' '{print $2}')
          echo "DROPS_ETAG=$DROPS_ETAG" >> $GITHUB_OUTPUT
          # æ‰“å°ETagä¾›è°ƒè¯•
          echo "======= ã€å‰ç½®ã€‘ä»…è·å–ETag ======="
          echo "createsæœ€æ–°ETag: $CREATES_ETAG"
          echo "dropsæœ€æ–°ETag: $DROPS_ETAG"

      # æ ¸å¿ƒæ”¹3ï¼šå…ˆè¯»å–å†å²ETagï¼Œå¯¹æ¯”åå†³å®šæ˜¯å¦ä¸‹è½½/å–æ¶ˆå·¥ä½œæµ
      - name: Check ETag change before download
        id: pre-check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          MONTH="${{ steps.set-month.outputs.month }}"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          mkdir -p dump # ç¡®ä¿dumpç›®å½•å­˜åœ¨

          # åˆå§‹åŒ–å˜æ›´æ ‡è®°
          CHANGED="false"
          # åˆå§‹åŒ–å†å²ETagå˜é‡
          HIST_CREATES_ETAG=""
          HIST_DROPS_ETAG=""

          # è¯»å–monthly_size.txtä¸­çš„å†å²ETagï¼ˆé”®å€¼æ ¼å¼ï¼‰
          if [ -f "$MONTHLY_SIZE_FILE" ]; then
            echo "======= è¯»å–å†å²monthly_size.txt ======="
            # æå–c{å¹´æœˆ}_ETagçš„å€¼
            HIST_CREATES_ETAG=$(grep -E "^c${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            # æå–d{å¹´æœˆ}_ETAGçš„å€¼
            HIST_DROPS_ETAG=$(grep -E "^d${MONTH}_ETAG=" "$MONTHLY_SIZE_FILE" | awk -F'=' '{print $2}' | tr -d '"')
            echo "å†å²c${MONTH} ETag: $HIST_CREATES_ETAG"
            echo "å†å²d${MONTH} ETag: $HIST_DROPS_ETAG"
          else
            echo "======= monthly_size.txtä¸å­˜åœ¨ï¼Œé¦–æ¬¡æ‰§è¡Œ ======="
          fi

          # å¯¹æ¯”ETagï¼ˆåªè¦æœ‰ä¸€ä¸ªå˜åŒ–å°±åˆ¤å®šä¸ºæœ‰æ›´æ–°ï¼‰
          if [ "${{ steps.get-etag.outputs.CREATES_ETAG }}" != "$HIST_CREATES_ETAG" ] || [ "${{ steps.get-etag.outputs.DROPS_ETAG }}" != "$HIST_DROPS_ETAG" ]; then
            CHANGED="true"
            echo "======= ETagæœ‰å˜åŒ–ï¼Œå‡†å¤‡ä¸‹è½½æ–‡ä»¶ ======="
            echo "creates: å†å²[$HIST_CREATES_ETAG] â‰  æœ€æ–°[${{ steps.get-etag.outputs.CREATES_ETAG }}]"
            echo "drops: å†å²[$HIST_DROPS_ETAG] â‰  æœ€æ–°[${{ steps.get-etag.outputs.DROPS_ETAG }}]"
          else
            echo "======= ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½ ======="
            CHANGED="false"
          fi

          # è¾“å‡ºå˜æ›´æ ‡è®°åˆ°GitHubå˜é‡
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ”¹4ï¼šETagæ— å˜åŒ–æ—¶ç›´æ¥å–æ¶ˆå·¥ä½œæµï¼Œé¿å…ä¸‹è½½å¼€é”€
      - name: å–æ¶ˆå·¥ä½œæµï¼ˆETagæ— å˜åŒ–ï¼‰
        if: steps.pre-check.outputs.changed == 'false'
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'ETagæ— å˜åŒ–ï¼Œæ— éœ€ä¸‹è½½æ–‡ä»¶ï¼Œè‡ªåŠ¨å–æ¶ˆå·¥ä½œæµ'

      # æ ¸å¿ƒæ”¹5ï¼šä»…ETagå˜åŒ–æ—¶æ‰ä¸‹è½½æ–‡ä»¶
      - name: Download .gz files (only if ETag changed)
        if: steps.pre-check.outputs.changed == 'true'
        run: |
          echo "======= å¼€å§‹ä¸‹è½½æ–‡ä»¶ ======="
          # ä¸‹è½½creates.gz
          curl -s -o creates.gz https://api.poi.moe/dump/createitemrecords.gz
          # ä¸‹è½½drops.gz
          curl -s -o drops.gz https://api.poi.moe/dump/dropshiprecords.gz
          echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ"

      - name: Check if changed
        id: check
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          # å¤ç”¨pre-checkçš„changedç»“æœï¼Œé¿å…é‡å¤åˆ¤æ–­
          echo "changed=${{ steps.pre-check.outputs.changed }}" >> $GITHUB_OUTPUT
          if [ "${{ steps.pre-check.outputs.changed }}" = "false" ]; then
            exit 0 # æ— å˜åŒ–æ—¶ç›´æ¥é€€å‡ºï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
          fi

          # å®šä¹‰æœˆä»½å˜é‡ï¼ˆé¿å…åµŒå¥—å¼•ç”¨é—®é¢˜ï¼‰
          MONTH="${{ steps.set-month.outputs.month }}"
          # æ ¸å¿ƒæ”¹6ï¼šæ–‡ä»¶åä»c-2026-01.gzæ”¹ä¸ºc202601.gzï¼ŒdåŒç†
          C_HISTORY_GZ_FILE="dump/c${MONTH}.gz"
          D_HISTORY_GZ_FILE="dump/d${MONTH}.gz"
          MONTHLY_SIZE_FILE="dump/monthly_size.txt"
          
          echo "======= æ‰“å°ETagå†…å®¹ ======="
          # æ‹¼æ¥æœ€æ–°ETagï¼ˆä¿ç•™åŸæœ‰å˜é‡åï¼Œæœ€å°åŒ–æ”¹åŠ¨ï¼‰
          CREATES_ETAG="ETag: ${{ steps.get-etag.outputs.CREATES_ETAG }}"
          DROPS_ETAG="ETag: ${{ steps.get-etag.outputs.DROPS_ETAG }}"
          echo "creates ETag (æ¸…ç†å): $CREATES_ETAG"
          echo "drops ETag (æ¸…ç†å): $DROPS_ETAG"
          
          echo "======= æ‰“å°æ–‡ä»¶MD5å€¼ ======="
          # å¤„ç†creates.gz
          if [ -f "creates.gz" ]; then
            MD5_CREATES_GZ=$(md5sum creates.gz | awk '{print $1}')
            echo "âœ… creates.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_CREATES_GZ"
            # ç§»åŠ¨creates.gzåˆ°ç›®æ ‡è·¯å¾„
            mv creates.gz "$C_HISTORY_GZ_FILE"
            # è®¡ç®—createsæ–‡ä»¶å¤§å°
            C_FILE_SIZE_KB=$(du -k "$C_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $C_HISTORY_GZ_FILE å¤§å°: ${C_FILE_SIZE_KB} KB"
          else
            MD5_CREATES_GZ="N/A"
            C_FILE_SIZE_KB="N/A"
            echo "âŒ creates.gz æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # å¤„ç†drops.gz
          if [ -f "drops.gz" ]; then
            MD5_DROPS_GZ=$(md5sum drops.gz | awk '{print $1}')
            echo "âœ… drops.gz (æœ€æ–°æ–‡ä»¶) MD5: $MD5_DROPS_GZ"
            # ç§»åŠ¨drops.gzåˆ°ç›®æ ‡è·¯å¾„
            mv drops.gz "$D_HISTORY_GZ_FILE"
            # è®¡ç®—dropsæ–‡ä»¶å¤§å°
            D_FILE_SIZE_KB=$(du -k "$D_HISTORY_GZ_FILE" | awk '{print $1}')
            echo "âœ… $D_HISTORY_GZ_FILE å¤§å°: ${D_FILE_SIZE_KB} KB"
          else
            MD5_DROPS_GZ="N/A"
            D_FILE_SIZE_KB="N/A"
            echo "âŒ drops.gz æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # ====================== æ ¸å¿ƒæ”¹7ï¼šå†™å…¥monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰ ======================
          echo "======= å†™å…¥monthly_size.txtï¼ˆé”®å€¼æ ¼å¼ï¼‰ ======="
          # è·å–å½“å‰æ£€æŸ¥æ—¶é—´ï¼ˆISOæ ¼å¼ï¼Œæ–¹ä¾¿è§£æï¼‰
          CHECK_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # å…ˆåˆ é™¤å½“å‰æœˆä»½çš„æ—§è®°å½•ï¼ˆé¿å…é‡å¤ï¼‰
          grep -v -E "^[cd]${MONTH}_" "$MONTHLY_SIZE_FILE" > "$MONTHLY_SIZE_FILE.tmp" 2>/dev/null || true
          # å†™å…¥createsçš„é”®å€¼
          echo "c${MONTH}_ETAG=\"${{ steps.get-etag.outputs.CREATES_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_MD5=\"${MD5_CREATES_GZ}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_SizeKB=\"${C_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "c${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          # å†™å…¥dropsçš„é”®å€¼
          echo "d${MONTH}_ETAG=\"${{ steps.get-etag.outputs.DROPS_ETAG }}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_MD5=\"${MD5_DROPS_GZ}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_SizeKB=\"${D_FILE_SIZE_KB}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          echo "d${MONTH}_CheckTime=\"${CHECK_TIME}\"" >> "$MONTHLY_SIZE_FILE.tmp"
          # æ›¿æ¢åŸæ–‡ä»¶
          mv "$MONTHLY_SIZE_FILE.tmp" "$MONTHLY_SIZE_FILE"
          
          # æ‰“å°å†™å…¥ç»“æœ
          echo "âœ… monthly_size.txt å†™å…¥å®Œæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
          cat "$MONTHLY_SIZE_FILE"

          # ====================== åŸæœ‰é€»è¾‘ï¼šè¾“å‡ºæœ€ç»ˆç»“è®º ======================
          echo -e "\n======= ã€æ ¸å¿ƒã€‘æœ€ç»ˆåˆ¤å®š ======="
          echo "ğŸ“Œ æœ€ç»ˆç»“è®ºï¼šData updated! Saving new .gz (ETagå·²å˜åŒ–)"

      - name: Commit and push .gz if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dump/
          git commit -m "Update createitemrecords/dropshiprecords ${{ steps.set-month.outputs.month }}.gz"
          git push
