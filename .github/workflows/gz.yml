name: gz

on:
  workflow_run:
    workflows: ["dump"]
    types:
      - completed
  workflow_dispatch:     # 手动触发  push:

jobs:
  convert-to-json:
    runs-on: ubuntu-latest
    # 只有当上游 workflow 成功时才运行
    outputs:
      d-length: ${{ steps.d-length.outputs.length }}
      c-length: ${{ steps.c-length.outputs.length }}
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 确保能 push

      - name: Install MongoDB Server and Tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-server mongodb-database-tools

      - name: Install Python and pymongo
        run: |
          sudo apt-get install -y python3-pip
          pip3 install pymongo

      - name: Start temporary MongoDB instance
        run: |
          mkdir -p /tmp/mongodata
          mongod --dbpath /tmp/mongodata --logpath /tmp/mongod.log --fork --quiet

      - name: Determine current month
        id: month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      - name: Restore archive directly from .gz
        run: |
          mongorestore --gzip --archive=dump/d${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createshiprecords" \
          mongorestore --gzip --archive=dump/c${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createitemrecords" 

      - name: Export simplified JSON using Python
        run: |
          mkdir -p dump
          python3 - << 'EOF'
          from pymongo import MongoClient
          import json

          client = MongoClient('mongodb://localhost:27017/')
          db = client['poi-production']
          def export_processed_mongodb_data(collection, output_file):
              """
              从MongoDB集合读取数据，按指定逻辑处理后导出为JSON文件
              
              参数:
                  collection: MongoDB集合对象
                  output_file: 输出JSON文件的路径
              """
              # 查询指定字段，排除_id
              cursor = collection.find({}, {'_id': 0, 'items': 1, 'itemId': 1, 'teitokuLv': 1, 'successful': 1, 'secretary': 1})
              first = True

              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write('{"RECORDS": [')
                  for doc in cursor:
                      # secretary为整数0或字符串"0"的情况
                      secretary_val = doc.get('secretary')
                      if secretary_val in (0, "0"):
                          continue  # 跳过secretary=0的记录，不写入文件
                      
                      # === 对应SQL: UPDATE d2 set itemId=-1 的两个条件 ===
                      item_id = doc.get('itemId')
                      successful_val = doc.get('successful')
                      
                      # 条件1: successful为false（兼容布尔False或字符串"false"）
                      # 条件2: itemId本身为0（兼容整数0或字符串"0"）
                      if successful_val in (False, "false") or item_id in (0, "0"):
                          processed_item_id = -1
                      else:
                          processed_item_id = item_id  # 保持原数值
                      
                      # 构造简化后的记录
                      simplified = [
                          doc.get('items', []),
                          processed_item_id,  # 使用处理后的itemId
                          doc.get('teitokuLv'),
                          1 if doc.get('successful') else 0, 
                          secretary_val
                      ]
                      if not first:
                          f.write(',')
                      f.write(json.dumps(simplified, ensure_ascii=False))
                      first = False
                  f.write(']}')

              print(f"处理后的JSON已导出到 {output_file}")
          collection = db['createitemrecords']
          export_processed_mongodb_data(collection, f"dump/d${{ steps.month.outputs.month }}.json")
          collection = db['createshiprecords']
          export_processed_mongodb_data(collection, f"dump/c${{ steps.month.outputs.month }}.json")
          EOF

      - name: Show result size
        run: |
          echo "Simplified JSON file generated:"
          ls -lh dump/d${{ steps.month.outputs.month }}.json
          echo "Line count (approx records + 2): $(wc < dump/d${{ steps.month.outputs.month }}.json)"
          ls -lh dump/c${{ steps.month.outputs.month }}.json
          echo "Line count (approx records + 2): $(wc < dump/c${{ steps.month.outputs.month }}.json)"

      # 调用自定义的可复用Action
      - name: Check JSON array length in develop
        id: d-length
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "dump/d${{ steps.month.outputs.month }}.json"  # 改为本地parsed目录
          output-var-name: "D_LENGTH"

      # 调用自定义的可复用Action
      - name: Check JSON array length in construction
        id: c-length
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "dump/c${{ steps.month.outputs.month }}.json"  # 改为本地parsed目录
          output-var-name: "C_LENGTH"
          
      - name: 取消工作流（LENGTH=0）
        if: steps.d-length.outputs.length == 0
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'MD5 无变化（c/d 均一致），无需提交，自动取消工作流'

      - name: Commit and push pure JSON (overwrite monthly file)
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add dump/
          git commit -m "Update monthly pure JSON: ${{ steps.month.outputs.month }}.json" || echo "No changes to commit"
          git push

      - name: Cleanup temporary MongoDB
        if: always()
        run: |
          mongo admin --eval "db.shutdownServer({force:true})" || true
          rm -rf /tmp/mongodata /tmp/mongod.log
