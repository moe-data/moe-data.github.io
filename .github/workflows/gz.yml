name: gz

on:
  workflow_run:
    workflows: ["dump"]
    types:
      - completed
  workflow_dispatch:     # 手动触发  push:

jobs:
  convert-to-json:
    runs-on: ubuntu-latest
    # 只有当上游 workflow 成功时才运行
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 确保能 push

      - name: Install MongoDB Server and Tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-server mongodb-database-tools

      - name: Install Python and pymongo
        run: |
          sudo apt-get install -y python3-pip
          pip3 install pymongo

      - name: Start temporary MongoDB instance
        run: |
          mkdir -p /tmp/mongodata
          mongod --dbpath /tmp/mongodata --logpath /tmp/mongod.log --fork --quiet

      - name: Determine current month
        id: month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      - name: Restore archive directly from .gz
        run: |
          mongorestore --gzip --archive=dump/c${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createshiprecords" \
                       --drop   # 确保覆盖旧数据
          mongorestore --gzip --archive=dump/d${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createitemrecords" \
                       --drop   # 确保覆盖旧数据

      - name: Export simplified JSON using Python
        run: |
          mkdir -p dump
          python3 - << 'EOF'
          from pymongo import MongoClient
          import json

          client = MongoClient('mongodb://localhost:27017/')
          db = client['poi-production']
          collection = db['createitemrecords']

          output_file = f"dump/d${{ steps.month.outputs.month }}.json"

          cursor = collection.find({}, {'_id': 0, 'items': 1, 'itemId': 1, 'teitokuLv': 1, 'successful': 1, 'secretary': 1})
          first = True

          with open(output_file, 'w', encoding='utf-8') as f:
              f.write('{"RECORDS": [')
              for doc in cursor:
                  simplified = [
                      doc.get('items', []),
                      doc.get('itemId'),
                      doc.get('teitokuLv'),
                      1 if doc.get('successful') else 0,
                      doc.get('secretary')
                  ]
                  if not first:
                      f.write(',')
                  f.write(json.dumps(simplified, ensure_ascii=False))
                  first = False
              f.write(']}')

          print(f"Simplified JSON exported to {output_file}")
          EOF

      - name: Show result size
        run: |
          echo "Simplified JSON file generated:"
          ls -lh dump/d${{ steps.month.outputs.month }}.json
          echo "Line count (approx records + 2): $(wc < dump/d${{ steps.month.outputs.month }}.json)"

      # 调用自定义的可复用Action
      - name: Check JSON array length in submodule
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "dump/d${{ steps.month.outputs.month }}.json"  # 改为本地parsed目录
          output-var-name: "DUMP_LENGTH"

      - name: Commit and push pure JSON (overwrite monthly file)
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add dump/d${{ steps.month.outputs.month }}.json
          git commit -m "Update monthly pure JSON: c${{ steps.month.outputs.month }}.json" || echo "No changes to commit"
          git push

      - name: Cleanup temporary MongoDB
        if: always()
        run: |
          mongo admin --eval "db.shutdownServer({force:true})" || true
          rm -rf /tmp/mongodata /tmp/mongod.log
