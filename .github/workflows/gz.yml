name: gz

on:
  push:
    paths:
      - '**/gz.yml'
  workflow_run:
    workflows: ["dump"]
    types:
      - completed
  workflow_dispatch:     # 手动触发  

jobs:
  convert-to-json:
    runs-on: ubuntu-latest
    # 只有当上游 workflow 成功时才运行
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      d-length: ${{ steps.d-length.outputs.length }}
      c-length: ${{ steps.c-length.outputs.length }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 确保能 push

      - name: Check cstypes array length
        id: cstypes
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "parsed/cstype.json"

      - name: Install MongoDB Server and Tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-server mongodb-database-tools

      - name: Install Python and pymongo
        run: |
          sudo apt-get install -y python3-pip
          pip3 install pymongo

      - name: Start temporary MongoDB instance
        run: |
          mkdir -p /tmp/mongodata
          mongod --dbpath /tmp/mongodata --logpath /tmp/mongod.log --fork --quiet

      - name: Determine current month
        id: month
        run: echo "month=$(date +%Y%m)" >> $GITHUB_OUTPUT

      - name: Restore archive directly from .gz
        run: |
          mongorestore --gzip --archive=dump/d${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createshiprecords"
          mongorestore --gzip --archive=dump/c${{ steps.month.outputs.month }}.gz \
                       --nsInclude="poi-production.createitemrecords" 

      - name: Export simplified JSON using Python
        run: |
          mkdir -p dump
          python3 - << 'EOF'
          from pymongo import MongoClient
          import json
          from collections import defaultdict

          client = MongoClient('mongodb://localhost:27017/')
          db = client['poi-production']
          
          # 新增：读取cstype.json用于LEFT JOIN逻辑（匹配SQL）
          def load_cstype_map():
              try:
                  with open('parsed/cstype.json', 'r', encoding='utf-8') as f:
                      cstype_data = json.load(f)
                      # 构建id到dtype的映射（匹配SQL: LEFT JOIN cstype b on secretary=b.id）
                      return {item.get('id'): item.get('dtype', -2) for item in cstype_data}
              except FileNotFoundError:
                  raise FileNotFoundError("cstype.json not found at parsed/cstype.json")
          
          cstype_map = load_cstype_map()
          
          def export_processed_mongodb_data(collection, output_file, output_type):
              """
              从MongoDB集合读取数据，按指定逻辑处理后导出为JSON文件
              
              参数:
                  collection: MongoDB集合对象
                  output_file: 输出JSON文件的路径
                  output_type: 字段类型（仅支持"itemId"或"shipId"），替换原itemId字段
              """
              # 新增：校验output_type合法性
              if output_type not in ("itemId", "shipId"):
                  raise ValueError(f"output_type must be 'itemId' or 'shipId', got {output_type}")
              
              # 查询指定字段，排除_id（替换itemId为output_type）
              cursor = collection.find({}, {'_id': 0, 'items': 1, output_type: 1, 'teitokuLv': 1, 'successful': 1, 'secretary': 1})
              first = True
              
              # 新增：用于统计重复条目（压缩到1条）
              record_stats = defaultdict(lambda: {'count': 0, 'min_teitokuLv': None})
              # 新增：存储异常条目（包含-2）
              abnormal_records = []
              
              # 第一步：遍历数据，统计重复&校验规则&处理SQL逻辑
              for doc in cursor:
                  # secretary为整数0或字符串"0"的情况
                  secretary_val = doc.get('secretary')
                  if secretary_val in (0, "0"):
                      continue  # 跳过secretary=0的记录，不写入文件
                  
                  # === 对应SQL: UPDATE d2 set itemId=-1 的两个条件 ===
                  # 替换itemId为output_type指定的字段
                  field_val = doc.get(output_type)
                  successful_val = doc.get('successful')
                  
                  # 条件1: successful为false（兼容布尔False或字符串"false"）
                  # 条件2: 字段本身为0（兼容整数0或字符串"0"）
                  if successful_val in (False, "false") or field_val in (0, "0"):
                      o = -1
                  else:
                      o = field_val  # 保持原数值
                  
                  # 新增：抛出错误 - successful与o值不匹配
                  if (successful_val in (False, "false") and o > -1) or (successful_val in (True, "true") and o < 1):
                      raise ValueError(f"Invalid o value: successful={successful_val}, o={o}, doc={doc}")
                  
                  # 新增：处理SQL的ifnull逻辑（空值替换为-2）
                  # 处理items（排除'[null,null,null,null]'、''、'[]'）
                  items_val = doc.get('items', [])
                  items_str = json.dumps(items_val, ensure_ascii=False)
                  if items_str in ('[null,null,null,null]', '', '[]'):
                      items_final = -2
                  else:
                      items_final = items_val
                  
                  # 处理secretary（匹配SQL: LEFT JOIN cstype b on secretary=b.id）
                  secretary_str = secretary_val if secretary_val is not None else -2
                  secretary_final = secretary_str #cstype_map.get(secretary_str, -2)
                  
                  # 处理teitokuLv（记录最小值，匹配SQL: min(teitokuLv)）
                  teitoku_lv = doc.get('teitokuLv', -2)
                  teitoku_lv = int(teitoku_lv) if teitoku_lv not in (None, "") else -2
                  
                  # 处理o（ifnull为-2）
                  o_final = o if o is not None else -2
                  
                  # 构造简化后的记录（用于去重）
                  simplified_key = (
                      json.dumps(items_final, ensure_ascii=False),
                      secretary_final,
                      o_final
                  )
                  
                  # 统计重复次数&更新最小teitokuLv
                  record_stats[simplified_key]['count'] += 1
                  if record_stats[simplified_key]['min_teitokuLv'] is None or teitoku_lv < record_stats[simplified_key]['min_teitokuLv']:
                      record_stats[simplified_key]['min_teitokuLv'] = teitoku_lv
                  
                  # 新增：标记异常条目（包含-2）
                  if -2 in (items_final, secretary_final, o_final, teitoku_lv):
                      abnormal_records.append({
                          'i': items_final,
                          's': secretary_final,
                          'o': o_final,
                          'n': record_stats[simplified_key]['count'],
                          'l': teitoku_lv
                      })
              
              # 新增：校验压缩后的条目数量（<5则exit2）
              compressed_count = len(record_stats)
              if compressed_count < 5:
                  print(f"Error: Compressed record count ({compressed_count}) < 5")
                  exit(2)
              
              # 第二步：写入压缩后的JSON（替换successful为出现次数）
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write('{"RECORDS": [')
                  for idx, (key, stats) in enumerate(record_stats.items()):
                      items_final = json.loads(key[0])
                      secretary_final = key[1]
                      o_final = key[2]
                      count = stats['count']
                      min_teitoku_lv = stats['min_teitokuLv'] if stats['min_teitokuLv'] is not None else -2
                      
                      # 构造最终记录（匹配SQL输出结构）
                      final_record = [
                          items_final,
                          secretary_final,
                          o_final,
                          count,  # 替换原successful的1/0为出现次数
                          min_teitoku_lv
                      ]
                      
                      if idx > 0:
                          f.write(',')
                      f.write(json.dumps(final_record, ensure_ascii=False))
                  f.write(']}')
              
              # 新增：打印异常条目（包含-2）
              print(f"\n======= 异常条目（包含-2）=======")
              for idx, rec in enumerate(abnormal_records):
                  print(f"异常条目{idx+1}: {json.dumps(rec, ensure_ascii=False)}")
              
              print(f"处理后的JSON已导出到 {output_file}")
              print(f"压缩后条目数量: {compressed_count}")
          
          # 调用函数 - createitemrecords（output_type=itemId）
          collection = db['createitemrecords']
          export_processed_mongodb_data(collection, f"dump/d${{ steps.month.outputs.month }}.json", "itemId")
          
          # 调用函数 - createshiprecords（output_type=shipId）
          collection = db['createshiprecords']
          export_processed_mongodb_data(collection, f"dump/c${{ steps.month.outputs.month }}.json", "shipId")
          EOF

      - name: Show result size
        run: |
          echo "Simplified JSON file generated:"
          ls -lh dump/d${{ steps.month.outputs.month }}.json
          echo "Line count (approx records + 2): $(wc < dump/d${{ steps.month.outputs.month }}.json)"
          ls -lh dump/c${{ steps.month.outputs.month }}.json
          echo "Line count (approx records + 2): $(wc < dump/c${{ steps.month.outputs.month }}.json)"

      # 新增：Get d file length (MongoDB export)
      - name: Check d${{ steps.month.outputs.month }}.json length
        id: d-length
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "dump/d${{ steps.month.outputs.month }}.json"

      # 新增：Get c file length (MongoDB export)
      - name: Check c${{ steps.month.outputs.month }}.json length
        id: c-length
        uses: ./.github/actions/check-json-length
        with:
          json-file-path: "dump/c${{ steps.month.outputs.month }}.json"

      # 新增：Update summary JSON with length data
      - name: Update summary JSON with length info
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: write
          filename: "dump/size-d.json"
          field: "${{ steps.month.outputs.month }}.SizeKB"
          value: "${{ steps.d-length.outputs.length }}"

      - name: Update summary JSON with c length info
        uses: shaneapowell/github-tweak-the-json@v1
        with:
          action: write
          filename: "dump/size-c.json"
          field: "${{ steps.month.outputs.month }}.SizeKB"
          value: "${{ steps.c-length.outputs.length }}"      

      - name: 取消工作流（LENGTH=0）
        if: steps.d-length.outputs.length == 0
        uses: conbanwa/cancel-workflow/.github/actions/cancel-workflow@v1.0.0
        with:
          cancel-reason: 'MD5 无变化（c/d 均一致），无需提交，自动取消工作流'

      - name: Commit and push pure JSON (overwrite monthly file)
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add dump/
          git commit -m "Update monthly pure JSON: ${{ steps.month.outputs.month }}.json" || echo "No changes to commit"
          git push

      - name: Cleanup temporary MongoDB
        if: always()
        run: |
          mongo admin --eval "db.shutdownServer({force:true})" || true
          rm -rf /tmp/mongodata /tmp/mongod.log
